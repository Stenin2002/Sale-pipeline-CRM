<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sales Pipeline Mini-CRM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background: #f4f5f7; margin:0; padding:20px; }
    h1 { margin:0; font-size:24px; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .topbar { display:flex; gap:10px; }
    input, select, textarea, button {
      padding:8px; border:1px solid #ccc; border-radius:5px; font-size:14px;
    }
    button { cursor:pointer; background:#0066ff; color:white; border:none; }
    button.grey { background:#ccc; color:#000; }

    .layout { display:flex; gap:15px; }
    .column {
      flex:1; background:#fff; padding:10px;
      border-radius:8px; height:75vh; overflow-y:auto;
      border:1px solid #ddd;
    }
    .col-header { font-weight:bold; margin-bottom:10px; display:flex; justify-content:space-between; }

    .lead-card {
      background:#fafafa; padding:10px; border-radius:6px;
      margin-bottom:10px; border:1px solid #ddd;
    }

    .small { font-size:13px; color:#555; }
    .value { font-weight:bold; }
    .status-pill {
      background:#e6f0ff; padding:4px 8px; border-radius:20px;
      font-size:12px; color:#0055cc;
    }

    /* Modal */
    .modal {
      position:fixed; inset:0;
      background:rgba(0,0,0,0.4);
      display:none; align-items:center; justify-content:center;
    }
    .modal-box {
      background:#fff; padding:20px; border-radius:10px; width:400px;
    }
  </style>
</head>
<body>

<header>
  <h1>Sales Pipeline Mini-CRM</h1>
  <div class="topbar">
    <input id="searchInput" placeholder="Search leads..." />
    <select id="statusFilter">
      <option value="">All</option>
      <option>New Lead</option>
      <option>Contacted</option>
      <option>Qualified</option>
      <option>Proposal Sent</option>
      <option>Won</option>
      <option>Lost</option>
    </select>
    <button id="openAdd">+ New Lead</button>
  </div>
</header>

<div class="layout" id="columns"></div>

<!-- Modal -->
<div id="modal" class="modal">
  <div class="modal-box">
    <h3 id="modalTitle">Add Lead</h3>
    <input id="leadName" placeholder="Contact name" />
    <input id="leadCompany" placeholder="Company" />
    <input id="leadEmail" placeholder="Email" />
    <input id="leadValue" placeholder="Value (e.g., 2500)" />
    <textarea id="leadNotes" placeholder="Notes"></textarea>
    <select id="leadStatus">
      <option>New Lead</option>
      <option>Contacted</option>
      <option>Qualified</option>
      <option>Proposal Sent</option>
      <option>Won</option>
      <option>Lost</option>
    </select>
    <br /><br />
    <button id="saveBtn">Save</button>
    <button class="grey" id="cancelBtn">Cancel</button>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
/* ===================================================================
   ðŸ”¥ Replace with YOUR Firebase config (Project Settings â†’ Web app)
   =================================================================== */
const firebaseConfig = {
  apiKey: "REPLACE_ME",
  authDomain: "REPLACE_ME.firebaseapp.com",
  projectId: "REPLACE_ME",
  storageBucket: "REPLACE_ME.appspot.com",
  messagingSenderId: "REPLACE_ME",
  appId: "REPLACE_ME"
};
/* ===================================================================
   END Firebase Config
   =================================================================== */

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const leadsCol = db.collection("leads");

const STATUSES = [
  "New Lead", "Contacted", "Qualified",
  "Proposal Sent", "Won", "Lost"
];

const modal = document.getElementById("modal");
const columns = document.getElementById("columns");

let editingId = null;

/* --------------------------------------------------------
   Build columns
-------------------------------------------------------- */
function buildColumns() {
  columns.innerHTML = "";
  STATUSES.forEach(s => {
    const div = document.createElement("div");
    div.className = "column";
    div.dataset.status = s;
    div.innerHTML = `
      <div class="col-header">
        <span>${s}</span>
        <span class="count small">0</span>
      </div>
      <div class="col-list"></div>
    `;
    columns.appendChild(div);
  });
}
buildColumns();

/* --------------------------------------------------------
   Modal handling
-------------------------------------------------------- */
function openModal(edit=false, data={}) {
  modal.style.display = "flex";
  document.getElementById("modalTitle").textContent = edit ? "Edit Lead" : "Add Lead";

  document.getElementById("leadName").value = data.name || "";
  document.getElementById("leadCompany").value = data.company || "";
  document.getElementById("leadEmail").value = data.email || "";
  document.getElementById("leadValue").value = data.value || "";
  document.getElementById("leadNotes").value = data.notes || "";
  document.getElementById("leadStatus").value = data.status || "New Lead";
}

function closeModal() {
  modal.style.display = "none";
  editingId = null;
}

document.getElementById("openAdd").onclick = () => openModal(false);
document.getElementById("cancelBtn").onclick = closeModal;

/* --------------------------------------------------------
   Save / Edit Lead
-------------------------------------------------------- */
document.getElementById("saveBtn").onclick = async () => {
  const lead = {
    name: document.getElementById("leadName").value,
    company: document.getElementById("leadCompany").value,
    email: document.getElementById("leadEmail").value,
    value: Number(document.getElementById("leadValue").value),
    notes: document.getElementById("leadNotes").value,
    status: document.getElementById("leadStatus").value,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  };

  if (editingId) {
    await leadsCol.doc(editingId).update(lead);
  } else {
    await leadsCol.add(lead);
  }
  closeModal();
};

/* --------------------------------------------------------
   Render cards
-------------------------------------------------------- */
function renderCard(doc) {
  const data = doc.data();
  const card = document.createElement("div");
  card.className = "lead-card";

  card.innerHTML = `
    <strong>${data.name}</strong> â€“ ${data.company || ""}
    <div class="small">${data.email}</div>
    <div class="small">${data.notes}</div>
    <hr>
    <div class="small">Value: <span class="value">$${data.value || 0}</span></div>
    <div class="status-pill">${data.status}</div>
    <br><br>
    <button class="grey" onclick="moveStatus('${doc.id}', -1)">â—€</button>
    <button class="grey" onclick="moveStatus('${doc.id}', +1)">â–¶</button>
    <button onclick="editLead('${doc.id}')">Edit</button>
    <button class="grey" onclick="deleteLead('${doc.id}')">Delete</button>
  `;

  return card;
}

/* --------------------------------------------------------
   Move status
-------------------------------------------------------- */
async function moveStatus(id, direction) {
  const snap = await leadsCol.doc(id).get();
  const data = snap.data();
  let idx = STATUSES.indexOf(data.status);
  idx = Math.min(Math.max(idx + direction, 0), STATUSES.length - 1);
  await leadsCol.doc(id).update({ status: STATUSES[idx] });
}

/* --------------------------------------------------------
   Edit & Delete
-------------------------------------------------------- */
async function editLead(id) {
  const snap = await leadsCol.doc(id).get();
  editingId = id;
  openModal(true, snap.data());
}
async function deleteLead(id) {
  if (confirm("Delete this lead?")) {
    leadsCol.doc(id).delete();
  }
}

/* --------------------------------------------------------
   Realtime listener
-------------------------------------------------------- */
leadsCol.orderBy("timestamp", "desc").onSnapshot(snapshot => {
  document.querySelectorAll(".col-list").forEach(list => list.innerHTML = "");
  document.querySelectorAll(".count").forEach(c => c.textContent = "0");

  snapshot.forEach(doc => {
    const data = doc.data();
    const status = data.status;

    const col = [...document.querySelectorAll(".column")]
      .find(c => c.dataset.status === status);

    col.querySelector(".col-list").appendChild(renderCard(doc));

    // update count
    const cnt = col.querySelector(".count");
    cnt.textContent = Number(cnt.textContent) + 1;
  });
});
</script>
</body>
</html>
